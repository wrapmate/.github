name: Auto-Seed Lovable Constraints

# This workflow is triggered by organization webhook when new repos are created
# No polling - purely event-driven!

on:
  repository_dispatch:
    types: [repository_created]
  workflow_dispatch:  # Manual trigger for testing

jobs:
  seed-constraints:
    runs-on: ubuntu-latest

    steps:
      - name: Check repository creator
        id: check_creator
        run: |
          # Only process repos created by j-bob-wm or lovable-dev[bot]
          CREATOR="${{ github.event.client_payload.creator }}"
          REPO_NAME="${{ github.event.client_payload.repository }}"

          echo "Repository: $REPO_NAME"
          echo "Creator: $CREATOR"

          # Filter by creator: j-bob-wm or lovable-dev[bot] (Lovable syncs)
          if [ "$CREATOR" = "j-bob-wm" ] || [ "$CREATOR" = "lovable-dev[bot]" ]; then
            echo "✓ Creator is $CREATOR (authorized), proceeding with seeding"
            echo "should_seed=true" >> $GITHUB_OUTPUT
            echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
          else
            echo "✗ Creator is $CREATOR (not authorized) - skipping"
            echo "should_seed=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout seeding script
        if: steps.check_creator.outputs.should_seed == 'true'
        uses: actions/checkout@v4
        with:
          repository: wrapmate/lovable-prototype-template
          token: ${{ secrets.GH_PAT }}
          path: template

      - name: Seed constraints
        if: steps.check_creator.outputs.should_seed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPO_NAME="${{ steps.check_creator.outputs.repo_name }}"

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Seeding constraints for: $REPO_NAME"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          # Check if constraints already exist
          if gh api "/repos/wrapmate/$REPO_NAME/contents/.lovable/constraints.md" >/dev/null 2>&1; then
            echo "✓ Constraints already exist, skipping"
            exit 0
          fi

          # Run the seeding script
          cd template
          chmod +x scripts/seed-lovable-constraints.sh
          ./scripts/seed-lovable-constraints.sh "$REPO_NAME"

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Seeding completed successfully!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
